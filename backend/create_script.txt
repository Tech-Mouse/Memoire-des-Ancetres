-- Remove conflicting tables (SQLite does not support CASCADE on DROP TABLE)
DROP TABLE IF EXISTS cemetery_on_address;
DROP TABLE IF EXISTS address;
DROP TABLE IF EXISTS is_buried_at;
DROP TABLE IF EXISTS cemetery;
DROP TABLE IF EXISTS category;
DROP TABLE IF EXISTS has_category;
DROP TABLE IF EXISTS is_parent_of;
DROP TABLE IF EXISTS is_spouse_of;
DROP TABLE IF EXISTS person;


-- Create tables

CREATE TABLE address (
	address_id INTEGER PRIMARY KEY AUTOINCREMENT,
	country TEXT,
	city TEXT,
	street TEXT,
	house_number INTEGER
);

CREATE TABLE category (
category_id INTEGER PRIMARY KEY AUTOINCREMENT,
name TEXT NOT NULL
);

CREATE TABLE cemetery (
	cemetery_id INTEGER PRIMARY KEY AUTOINCREMENT,
	cemetery_name TEXT
);

CREATE TABLE cemetery_on_address (
	cemetery_id INTEGER NOT NULL,
	address_id INTEGER NOT NULL,
	PRIMARY KEY(cemetery_id,address_id),
	FOREIGN KEY(address_id) REFERENCES address (address_id) ON DELETE CASCADE,
	FOREIGN KEY(cemetery_id) REFERENCES cemetery (cemetery_id) ON DELETE CASCADE
);

CREATE TABLE person (
    person_id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL,
    surname TEXT NOT NULL,
    date_of_birth TEXT NOT NULL,
    date_of_death TEXT,
    image TEXT
);

CREATE TABLE has_category (
    category_id INTEGER NOT NULL,
    person_id INTEGER NOT NULL,
    text TEXT NOT NULL,
    PRIMARY KEY (category_id, person_id),
    FOREIGN KEY (category_id) REFERENCES category (category_id) ON DELETE CASCADE,
    FOREIGN KEY (person_id) REFERENCES person (person_id) ON DELETE CASCADE
);

CREATE TABLE is_buried_at (
	cemetery_id INTEGER NOT NULL,
	person_id INTEGER NOT NULL,
	PRIMARY KEY(cemetery_id,person_id),
	FOREIGN KEY(cemetery_id) REFERENCES cemetery (cemetery_id) ON DELETE CASCADE,
	FOREIGN KEY(person_id) REFERENCES person (person_id) ON DELETE CASCADE
);

CREATE TABLE is_parent_of (
    parent_id INTEGER NOT NULL,
    child_id  INTEGER NOT NULL,
    PRIMARY KEY (parent_id, child_id),
    FOREIGN KEY (parent_id) REFERENCES person (person_id) ON DELETE CASCADE,
    FOREIGN KEY (child_id) REFERENCES person (person_id) ON DELETE CASCADE
);

CREATE TABLE is_spouse_of (
    wife_id INTEGER NOT NULL,
    husband_id INTEGER NOT NULL,
    PRIMARY KEY (wife_id, husband_id),
    FOREIGN KEY (wife_id) REFERENCES person (person_id) ON DELETE CASCADE,
    FOREIGN KEY (husband_id) REFERENCES person (person_id) ON DELETE CASCADE
);

-- Populate tables

BEGIN TRANSACTION;
INSERT INTO "category" ("category_id","name") VALUES (1,'Naissance');
INSERT INTO "category" ("category_id","name") VALUES (2,'Mariage');
INSERT INTO "category" ("category_id","name") VALUES (3,'Enfants');
INSERT INTO "category" ("category_id","name") VALUES (4,'Mort');
INSERT INTO "category" ("category_id","name") VALUES (5,'Notes');

INSERT INTO "has_category" ("category_id","person_id","text") VALUES (1,1,'Le dimanche 15 avril 1866 à Avirey-Lingey (10340).
Fille de Frédéric Pierre RACLOT et de Alexandrine Joséphine Viard.
');
INSERT INTO "has_category" ("category_id","person_id","text") VALUES (2,1,'Avec Albert Henri ROUSSEL, instituteur (1864-1917)');
INSERT INTO "has_category" ("category_id","person_id","text") VALUES (3,1,'Gaston né le 7 juillet 1887, (Mathilde a 21 ans). Il meurt le 22 septembre 1918.
Charles né en 1889 et il meurt en 1918.
Germaine Marie Antoinette née le 27 octobre 1893 et elle meurt le 12 juin 1973.');
INSERT INTO "has_category" ("category_id","person_id","text") VALUES (4,1,'Le lundi 24 décembre 1928 à La Rochelle à l’âge de 62 ans.');
INSERT INTO "has_category" ("category_id","person_id","text") VALUES (5,1,'Son époux Albert et ses 2 garçons décèdent de la grippe Espagnole. Elle est la mère de Germaine qui est, elle aussi, inhumée dans cette tombe.');

INSERT INTO "is_parent_of" ("parent_id","child_id") VALUES (1,3);
INSERT INTO "is_parent_of" ("parent_id","child_id") VALUES (2,3);

INSERT INTO "is_spouse_of" ("wife_id","husband_id") VALUES (1,2);
INSERT INTO "is_spouse_of" ("wife_id","husband_id") VALUES (2,1);

INSERT INTO "person" ("person_id","name","surname","date_of_birth","date_of_death","image","short_description") VALUES (1,'Mathilde','Raclot - Roussel','15.4.1866','24.12.1928',NULL,'');
INSERT INTO "person" ("person_id","name","surname","date_of_birth","date_of_death","image","short_description") VALUES (2,'Albert Henri','Roussel','1864','1917','','');
INSERT INTO "person" ("person_id","name","surname","date_of_birth","date_of_death","image","short_description") VALUES (3,'Germaine Marie Antoinette','Roussel - Hautier','27.12.1893','12.6.1973',NULL,'');

COMMIT;
